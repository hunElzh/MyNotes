## 基本概念

### 集群、节点、分片的基本概念

- 集群：集群是由一个或者多个拥有相同 `cluster.name` 配置的节点组成的一个服务。
- 节点：即一个正在运行的 ES 服务。节点又被分为主节点和普通的节点
  - 主节点：负责管理集群范围内的所有变更操作，例如增删索引、增删节点等。
  - 节点：即一个集群中普通的节点
- *分片*：一个Luence实例；底层存储文档的地方；组成索引的底层存储结构。当集群规模扩大或者缩小时，ES会
  - 主分片：存储所有文档的分片（主分片的数目决定着当前索引能够保存的最大数据量）
  - 副本分片：一个主分片的拷贝

> 一些小细节
>
> - 集群
>   1. 集群中的节点它们共同承担数据和负载的压力，并且当由节点加入集群中或者从集群中移除节点时，集群将会重新平均分布节点中所有的数据。
>   2. 只要启动了一个ES服务，就算里面没有文档，这个ES服务也被称之为集群，只不过这是一个只有一个节点，并且节点中没有文档的*空集群*
> - 节点
>   1. **每个节点** 都知道 **任意文档** 在 ES 中所处的位置。所以无论我们将请求发送至哪个节点，ES都能转发请求，随后将对应需要查找的文档返回给我们。
> - 分片
>   1. ES 中的**索引**，实际上**指向**一个或者多个**物理分片** 。
>   2. 技术上来说，一个主分片最大能够存储 Integer.MAX_VALUE - 128 个文档，但是实际最大值还需要参考你的使用场景：包括你使用的硬件， 文档的大小和复杂程度，索引和查询文档的方式以及你期望的响应时长。 
>   3. 副本分片的作用：硬件故障时保护数据不丢失的冗余备份（容灾）；为搜索和返回文档等读操作提供服务（读写分离）。
>   4. 主分片的数目在索引创建时就已经确定了下来。 
>   5. 主分片的数量由索引决定，副本分片的数量可以修改，一个主分片可以对应零个至多个副本分片（要注意副本分片其实算是主分片的数据冗余，不能创建太多）
>   6. 当一个ES集群中有两个节点时，所有新近被索引的文档都将会保存在主分片上，然后被并行的复制到对应的副本分片上。这就保证了我们既可以从主分片又可以从副本分片上获得文档。



### 集群健康

```sense
GET /_cluster/health
```

此命令返回集群监控信息，具体如下

~~~ js
{
  "cluster_name" : "elasticsearch",		//集群名称
  "status" : "yellow",		//集群健康状态
  "timed_out" : false,
  "number_of_nodes" : 1,		//节点数
  "number_of_data_nodes" : 1,		
  "active_primary_shards" : 7,		
  "active_shards" : 7,		//主分片
  "relocating_shards" : 0,
  "initializing_shards" : 0,
  "unassigned_shards" : 5,		//未被分配的副本分片
  "delayed_unassigned_shards" : 0,
  "number_of_pending_tasks" : 0,
  "number_of_in_flight_fetch" : 0,
  "task_max_waiting_in_queue_millis" : 0,
  "active_shards_percent_as_number" : 58.333333333333336
}
~~~

status属性表示当前集群的健康状态，它三个状态值

- green： 所有的主分片和副本分片都正常运行。 
- yellow： 所有的主分片都正常运行，但不是所有的副本分片都正常运行。存在数据丢失风险 
- red： 有主分片没能正常运行。 



## 创建一个健康的集群

### 1. 空集群

> 首先得初始化一个集群，当一个ES节点被运行时，说明集群已经产生

![elas_0201](E:\Study\Mynotes\MyNotes\img\elas_0201.png)

上图表示的就是一个空集群，该集群只有一个节点，并且节点中没有存储任何的文档，在该集群中NODE1默认为集群的主节点。



### 2. 给集群添加一个索引

> 单单初始化一个空集群没有任何用处，我们用ES要查文档，而文档时存在索引之中的，且索引存储在分片之中，此时我们创建名为 `blogs` 的索引。索引在默认情况下会被分配5个主分片，每个主分片会被默认分配一个副本分片，为了演示（跟着官方文档例子走咯）我们将索引分配三个主分片和一份副本分片

```sense
PUT /blogs
{
   "settings" : {
      "number_of_shards" : 3,		//给索引分配的主分片数量
      "number_of_replicas" : 1		//给一个索引分配的副本分片的数量
   }
}
```

执行完上述，我们即可创建一个被分配三个主分片的名为blogs索引，并且每个主分片都被分配了一个副本分片

此时我们查询集群健康，结果如下

~~~ js
{
  "cluster_name" : "elasticsearch",
  "status" : "yellow",		//应为副本分片未被分配节点，所以集群健康状态为yellow
  "timed_out" : false,
  "number_of_nodes" : 1,
  "number_of_data_nodes" : 1,
  "active_primary_shards" : 5,
  "active_shards" : 5,
  "relocating_shards" : 0,
  "initializing_shards" : 0,
  "unassigned_shards" : 3,		//此时所有副本分片均未被分配节点（即主节点和副本节点在同一节点之上）
  "delayed_unassigned_shards" : 0,
  "number_of_pending_tasks" : 0,
  "number_of_in_flight_fetch" : 0,
  "task_max_waiting_in_queue_millis" : 0,
  "active_shards_percent_as_number" : 62.5
}
~~~

此时集群是正常运行的，因为主分片可以完成文档的读写操作。这种情况下，主分片和副本分片全都存储在同一个节点之中。这样一来，节点如果出了故障，主分片中的数据和副本分片中的数据会一同丢失，副本分片的存在也毫无意义了。

那么如何解决这种情况并且利用好我们创建的副本分片呢？



### 3. 添加一个节点

只有一个节点的集群，那和起一个单独的服务有啥区别(⌐■_■)，因此我们引入一个节点，来存储副本分片，这样主分片跟着节点挂了之后，咱们副本分片岂不是就能登基了？

![拥有两个节点的集群](..\img\elas_0203.png)

当第二个节点加入到集群后，3个 `副本分片` 将会分配到这个节点上——每个主分片对应一个副本分片。这意味着当集群中任何一个节点出现问题是，我们的数据都完好无损。



### 4. 再tm添加一个节点（水平扩容）

> 为了承受海量数据（雾），单单一个两个服务是完全不够的

 怎样为我们的正在增长中的应用程序按需扩容呢？ 当启动了第三个节点，我们的集群将会看起来如下图所示

![elas_0204](..\img\elas_0204.png)

`Node 1` 和 `Node 2` 上各有一个分片被迁移到了新的 `Node 3` 节点，现在每个节点上都拥有2个分片，而不是之前的3个。 这表示每个节点的硬件资源（CPU, RAM, I/O）将被更少的分片所共享，每个分片的性能将会得到提升。 

分片是一个功能完整的搜索引擎，它拥有使用一个节点上的所有资源的能力。 我们这个拥有6个分片（3个主分片和3个副本分片）的索引可以最大扩容到6个节点，每个节点上存在一个分片，并且每个分片拥有所在节点的全部资源。 



### 5. 更加安全！

> 单一个数据卷，我还是不放心

在运行中的集群上是可以动态调整副本分片数目的，我们可以按需伸缩集群。执行下列语句，让我们把副本数从默认的 `1` 增加到 `2` ： 

```sense
PUT /blogs/_settings
{
   "number_of_replicas" : 2
}
```

经过改动之后， `blogs` 索引现在拥有9个分片：3个主分片和6个副本分片。 这意味着我们可以将集群扩容到9个节点，每个节点上一个分片。相比原来3个节点时，集群搜索性能可以提升 *3* 倍。 

![elas_0205](..\img\elas_0205.png)

